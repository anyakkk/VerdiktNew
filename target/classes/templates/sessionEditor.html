<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8"/>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.4/math.js"></script>
    <title>Verdikt</title>

    <script>
        // Clears the screen on click of C button.
        function clearScreen() {
            document.getElementById("result").value = "";
        }
        // Displays entered value on screen.
        function liveScreen(value) {
            let res = document.getElementById("result");
            if(res.value == "undefined"){
                res.value = "";
            }
            res.value += value;
        }
    </script>

    <script th:text="'var session=' + ${sessionId}">
    </script>

    <script th:if="${userApps}" th:text="'var appsCount = ' + ${userApps.size()}">
    </script>

    <script th:if="${userApps}">
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function loop() {
            while (true) {
                await sleep(1000);
                axios.get("/status?session="+session + "&count="+appsCount, {
                    withCredentials: true
                }).then((resp) => {
                    if (resp.data)
                        location.reload();
                });
            }
        }
        loop();
    </script>

    <script>
        function startSession() {
            location.replace("/currentSession?session="+session
                + "&startSession=true"
            )
        }
        function endSession() {
            location.replace("/currentSession?session="+session
                + "&endSession=true"
            )
        }
        function createSession() {
            location.replace("/currentSession?session=-1"
                + "&testId="+session
                + "&name=\""+document.getElementById('input-name').value+"\""
                + "&minutes="+document.getElementById('input-minutes').value
                + "&sessionTime="+document.getElementById('input-time').value
            )
        }
    </script>

</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand">Вердикт</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarScroll">
            <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 100px;">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarScrollingDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Пользователь
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarScrollingDropdown">
                        <li><a class="dropdown-item" href="/logout">Выйти</a></li>
                        <li><hr class="dropdown-divider"></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#ModalCalc" style="margin-right: 10px">
                        Калькулятор
                    </button>
                    <div class="modal" id="ModalCalc" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Калькулятор</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="wrapper">
                                        <div class="container">
                                            <div class="first-row">
                                                <input type="text" name="result" class="result" id="result" value="" placeholder="Результат" readonly />
                                                <input type="button" value="C" onclick="clearScreen()" id="clear" />
                                            </div>
                                            <div class="second-row">
                                                <input type="button" value="1" onclick="liveScreen(1)" id="one" />
                                                <input type="button" value="2" onclick="liveScreen(2)" id="two" />
                                                <input type="button" value="3" id="three" onclick="liveScreen(3)" />
                                                <input type="button" value="+" onclick="liveScreen('+')" />
                                            </div>
                                            <div class="third-row">
                                                <input type="button" value="4" id="four" onclick="liveScreen(4)" />
                                                <input type="button" value="5" id="five" onclick="liveScreen(5)" />
                                                <input type="button" value="6" id="six" onclick="liveScreen(6)" />
                                                <input type="button" value="-" onclick="liveScreen('-')" />
                                            </div>
                                            <div class="fourth-row">
                                                <input type="button" value="7" id="seven" onclick="liveScreen(7)" />
                                                <input type="button" value="8" id="eight" onclick="liveScreen(8)" />
                                                <input type="button" value="9" id="nine" onclick="liveScreen(9)" />
                                                <input type="button" value="x" onclick="liveScreen('*')" />
                                            </div>
                                            <div class="fifth-row">
                                                <input type="button" value="/" onclick="liveScreen('/')" />
                                                <input type="button" value="0" id="zero" onclick="liveScreen(0)" />
                                                <input type="button" value="." class="dot" onclick="liveScreen('.')" />
                                                <input type="button" value="=" onclick="result.value = eval(result.value)" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </li>

                <li class="nav-item">
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#Modal">
                        Справка
                    </button>
                    <div class="modal" id="Modal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Справка</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Задания делятся на 2 типа: с вариантом ответа и требующие ответа в специальном поле.</p>
                                    <p>Вернуться к предыдущему вопросу нельзя.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

        </div>
    </div>
</nav>



<style>
    .block {
        width: 100%;
        height: auto;
        padding: 5%;
        position:relative;
        font-family: "Gideon Roman";
        background-color: aliceblue;
        vertical-align: middle;
    }
    .center {
        background: white;
        max-width: 1000px;
        min-height: 100vh;
        margin-left: 15%;
        margin-right: 15%;
    }

    body {
        background: #E6E6E6;
        margin: 0;
        padding: 0;
    }
</style>

<div class="center">
    <div class="container" style="width: 500px">
        <div class="shadow p-3 bg-body rounded" style="position: relative; top: 190px; background-color: aliceblue!important">
            <div class="container">
                    <div class="row">
                        <div class="col-sm" th:unless="${userApps}">
                            <label class="form-check-label"  id="inputGroup" th:text = "'Тест: ' + ${testName}"></label>
                        </div>
                        <div class="col-sm" th:if="${userApps}">
                            <label class="form-check-label" id="inputGroup" th:text = "'ID сессии: ' + ${sessionId}"></label>
                        </div>

                        <div class="col-sm" th:unless="${started}">
                            <button class="btn btn-outline-secondary" th:if="${userApps}" onclick="startSession()" >Запустить</button>
                        </div>
                        <div class="col-sm" th:if="${started}">
                            <button th:unless="${ended}" class="btn btn-outline-secondary" onclick="endSession()" >Закончить</button>
                            <a th:if="${ended}" class="btn btn-outline-secondary"  href="/stat" >Посмотреть статистику</a>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-sm">
                            <label class="form-check-label" id="do">Создание сессии</label>
                        </div>
                        <div class="col-sm">
                            <label class="form-check-label" id="name">Название сессии:</label>
                            <input th:disabled="${readonly}" style="width: 100%" id="input-name" th:value="${name}" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                            <label class="form-check-label" id="inputGroup-sizing-default">Минут на решение:</label>
                            <input th:disabled="${readonly}" style="width: 50%" id="input-minutes" th:value="${mins}" type="number" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                            <label class="form-check-label" id="inputGr">Время сессии:</label>
                            <input th:disabled="${readonly}" style="width: 50%" id="input-time" type="number" th:value="${sessionTime}" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </div>

                    <hr>
                    <div class="col">

                        <p></p>

                        <button class="btn btn-outline-secondary" onclick="createSession()" th:unless="${userApps}" style="position: relative; left: 42%">Создать</button>

                        <div th:if="${ended}">
                            <div class="d-block" style="width:100%" th:each="result: ${userResults}">
                                <div style="display: flex">
                                    <div style="display: flex; flex-grow: 1" th:text="${result.username}">
                                    </div>

                                    <div style="display: flex; flex-grow: 0; min-width: 120px" th:if="${result.ref}">
                                        <div style="display: flex; flex-grow: 1">
                                            <div  class="btn btn-outline-primary"  th:text="${result.res}">
                                            </div>
                                        </div>

                                        <a style="display: flex; flex-grow: 0" class="btn btn-outline-success" th:href="${result.ref}">
                                            К результату
                                        </a>
                                    </div>
                                    <div style="display: flex; flex-grow: 0; min-width: 120px" th:unless="${result.ref}" th:text="${result.res}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:unless="${ended}">
                        <div th:if="${userApps}">
                            <div class="d-block" style="width:100%" th:each="userApp: ${userApps}">

                                <div style="display: flex">
                                    <div style="display: flex; flex-grow: 1" th:text="${userApp.user.username}">
                                    </div>

                                    <div style="display: flex; flex-grow: 0; min-width: 80px" th:if="${userApp.status.ordinal() EQ 0}">
                                        <div style="display: flex; flex-grow: 1">
                                            <a class="btn btn-outline-danger" th:href="'/currentSession?session=' + ${sessionId} + '&cancel=' + ${userApp.id}">
                                                -
                                            </a>
                                        </div>

                                        <a style="display: flex; flex-grow: 0" class="btn btn-outline-success" th:href="'/currentSession?session=' + ${sessionId} + '&accept=' + ${userApp.id}">
                                            +
                                        </a>
                                    </div>

                                    <div style="display: flex; flex-grow: 0" th:if="${userApp.status.ordinal() EQ 2}">
                                        Отклонено
                                    </div>

                                    <div style="display: flex; flex-grow: 0" th:if="${userApp.status.ordinal() EQ 1}">
                                        Принято
                                    </div>
                                </div>
                            </div>

                        </div>
                        </div>
                    </div>



            </div>

        </div>

    </div>
</div>
</body>
</html>